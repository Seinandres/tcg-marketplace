// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// --------------------------------------
// 1. USUARIOS & SUSCRIPCIONES
// --------------------------------------

model User {
  id            String    @id @default(uuid())
  username      String?   @unique
  email         String?   @unique 
  walletAddress String?   @unique
  rut           String?
  image         String?
  reputation    Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones Marketplace
  listings      Listing[] 
  purchases     Order[]   @relation("BuyerOrders")
  sales         Order[]   @relation("SellerOrders")
  cart          CartItem[]
  
  // Relación con Subastas (NUEVO)
  bids          Bid[]

  // Relación Suscripción
  subscription  Subscription?
}

model Subscription {
  id               String   @id @default(cuid())
  userId           String   @unique
  user             User     @relation(fields: [userId], references: [id])
  stripeCustomerId String   @unique
  stripePriceId    String
  status           String   
  currentPeriodEnd DateTime
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

// --------------------------------------
// 2. CATÁLOGO DE CARTAS (Mapeado para no borrar datos)
// --------------------------------------

model Set {
  // Mapeamos a la tabla antigua 'CardSet' para no perder datos
  @@map("CardSet") 

  id           String    @id 
  name         String
  series       String?   
  code         String?   
  printedTotal Int?
  
  // Mapeamos 'total' a la columna vieja 'totalCards'
  total        Int?      @map("totalCards")
  
  releaseDate  String?
  images       Json?     
  updatedAt    DateTime  @updatedAt @default(now())
  
  cards        Card[]
}

model Card {
  id            String    @id @default(cuid())
  
  // --- CAMPOS NUEVOS ---
  game          String    @default("Pokemon")
  supertype     String?   
  subtypes      String[]
  types         String[]
  hp            String?
  artist        String?
  
  imageUrlSmall String
  
  // Mapeamos a columna vieja para no perder imágenes
  imageUrlLarge String?   @map("imageUrlHiRes")
  
  // --- CAMPOS COMUNES ---
  name          String
  number        String
  rarity        String?
  
  // --- CAMPOS LEGACY ---
  marketPrice   Float?
  
  // --- RELACIONES ---
  setId         String
  set           Set       @relation(fields: [setId], references: [id])
  
  listings      Listing[]
  priceHistory  PriceHistory[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt 
}

// --------------------------------------
// 3. MARKETPLACE & LISTINGS (Ventas y Subastas)
// --------------------------------------

model Listing {
  id        String   @id @default(cuid())
  userId    String   
  user      User     @relation(fields: [userId], references: [id])
  cardId    String
  card      Card     @relation(fields: [cardId], references: [id])

  // Tipo de publicación: "SALE" (Venta) o "AUCTION" (Subasta)
  type      String   @default("SALE") 

  price     Int
  condition String
  quantity  Int      @default(1)
  status    String   @default("ACTIVE") 
  isNft     Boolean  @default(false)

  // Relaciones
  orders    Order[]
  cartItems CartItem[]
  bids      Bid[]    // Ofertas recibidas en subasta

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --------------------------------------
// 4. SISTEMA DE SUBASTAS (NUEVO)
// --------------------------------------

model Bid {
  id        String   @id @default(cuid())
  amount    Int      // Monto de la oferta
  createdAt DateTime @default(now())

  userId    String   // Quién oferta
  user      User     @relation(fields: [userId], references: [id])

  listingId String   // En qué subasta
  listing   Listing  @relation(fields: [listingId], references: [id])
}

// --------------------------------------
// 5. TRANSACCIONES & CARRITO
// --------------------------------------

model Order {
  id        String   @id @default(uuid())
  buyerId   String
  sellerId  String
  listingId String
  
  price     Int
  status    String   @default("COMPLETED")
  
  createdAt DateTime @default(now())

  buyer     User     @relation("BuyerOrders", fields: [buyerId], references: [id])
  seller    User     @relation("SellerOrders", fields: [sellerId], references: [id])
  listing   Listing  @relation(fields: [listingId], references: [id])
}

model CartItem {
  id        String   @id @default(uuid())
  userId    String
  listingId String
  quantity  Int      @default(1)

  user      User     @relation(fields: [userId], references: [id])
  listing   Listing  @relation(fields: [listingId], references: [id])
}

// --------------------------------------
// 6. HISTORIAL DE PRECIOS
// --------------------------------------

model PriceHistory {
  id      String   @id @default(uuid())
  cardId  String
  date    DateTime @default(now())
  price   Int
  
  card    Card     @relation(fields: [cardId], references: [id])
}