// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// --------------------------------------
// 1. USUARIOS (Híbrido: Web2 + Web3)
// --------------------------------------

model User {
  id            String    @id @default(uuid())
  username      String    @unique
  email         String?   @unique 
  walletAddress String?   @unique
  rut           String?
  image         String?
  reputation    Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  listings      Listing[] 
  purchases     Order[]   @relation("BuyerOrders")
  sales         Order[]   @relation("SellerOrders")
  cart          CartItem[]
}

// --------------------------------------
// 2. CATÁLOGO DE CARTAS
// --------------------------------------

model CardSet {
  id          String   @id @default(uuid())
  name        String
  code        String
  releaseDate String?
  totalCards  Int?
  
  cards       Card[]
}

model Card {
  id          String   @id @default(uuid())
  setId       String
  
  name        String
  number      String
  rarity      String
  
  imageUrlSmall String 
  imageUrlHiRes String?
  
  marketPrice   Float?

  set         CardSet  @relation(fields: [setId], references: [id])
  listings    Listing[]
  priceHistory PriceHistory[]
}

// --------------------------------------
// 3. MARKETPLACE & LISTINGS
// --------------------------------------

model Listing {
  id          String   @id @default(uuid())
  userId      String
  cardId      String
  
  price       Int
  condition   String
  quantity    Int      @default(1)
  status      String   @default("ACTIVE")
  
  isNft       Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id])
  card        Card     @relation(fields: [cardId], references: [id])
  orders      Order[]
  cartItems   CartItem[]
}

// --------------------------------------
// 4. TRANSACCIONES
// --------------------------------------

model Order {
  id            String   @id @default(uuid())
  buyerId       String
  sellerId      String
  listingId     String
  
  price         Int
  status        String   @default("COMPLETED")
  
  createdAt     DateTime @default(now())

  buyer         User     @relation("BuyerOrders", fields: [buyerId], references: [id])
  seller        User     @relation("SellerOrders", fields: [sellerId], references: [id])
  listing       Listing  @relation(fields: [listingId], references: [id])
}

model CartItem {
  id        String   @id @default(uuid())
  userId    String
  listingId String
  quantity  Int      @default(1)

  user      User     @relation(fields: [userId], references: [id])
  listing   Listing  @relation(fields: [listingId], references: [id])
}

// --------------------------------------
// 5. HISTORIAL DE PRECIOS
// --------------------------------------

model PriceHistory {
  id        String   @id @default(uuid())
  cardId    String
  date      DateTime @default(now())
  price     Int
  
  card      Card     @relation(fields: [cardId], references: [id])
}